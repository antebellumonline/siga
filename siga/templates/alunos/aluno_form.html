<!-- templates/alunos/aluno_form.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Formulário de Aluno</title>
</head>
<body>
    <h1>{{ form.instance.pk|yesno:"Editar,Adicionar" }} Aluno</h1>
    <form method="post">
        {% csrf_token %}
        <div>
            <label for="id_cep">CEP:</label>
            {{ form.cep }}
        </div>
        <div>
            <label for="id_logradouro">Logradouro:</label>
            {{ form.logradouro }}
        </div>
        <div>
            <label for="id_bairro">Bairro:</label>
            {{ form.bairro }}
        </div>
        <div>
            <label for="id_cidade">Cidade:</label>
            {{ form.cidade }}  <!-- Dropdown da cidade -->
        </div>
        <button type="submit">Salvar</button>
    </form>    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cepInput = document.querySelector('#id_cep');
            const logradouroInput = document.querySelector('#id_logradouro');
            const bairroInput = document.querySelector('#id_bairro');
            const cidadeInput = document.querySelector('#id_cidade');
    
            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');  // Remove caracteres não numéricos
                if (cep.length === 8) {
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.erro) {
                                logradouroInput.value = data.logradouro;
                                bairroInput.value = data.bairro;
                                // Você pode adicionar a lógica para setar a cidade com base no código IBGE retornado
                                const codigo_ibge = data.ibge;
                                fetchCidadePorCodigoIBGE(codigo_ibge);
                            } else {
                                alert('CEP não encontrado.');
                            }
                        });
                } else {
                    alert('Formato de CEP inválido.');
                }
            });
    
            function fetchCidadePorCodigoIBGE(codigo_ibge) {
                fetch(`/cidades/por-codigo-ibge/${codigo_ibge}/`)
                    .then(response => response.json())
                    .then(data => {
                        cidadeInput.value = data.cidade_id;
                    });
            }
        });
    </script>    
</body>
</html>
